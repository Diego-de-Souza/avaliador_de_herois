<div class="p-4">
  <h4>Segurança</h4>

  <!-- Alterar Senha -->
  <div class="mb-4">
    <h5>Alterar Senha</h5>
    <form [formGroup]="userSettingsForm" (ngSubmit)="onChangePassword()">
      <div class="row g-2">
        <div class="col-md-4">
          <input type="password" class="form-control" formControlName="newPassword" placeholder="Nova senha" />
        </div>
        <div class="col-md-4">
          <input type="password" class="form-control" formControlName="confirmNewPassword" placeholder="Confirmar nova senha" />
        </div>
        <div class="col-md-4">
          <button type="submit" class="btn btn-primary" [disabled]="userSettingsForm.invalid">Alterar Senha</button>
        </div>
      </div>
      @if (userSettingsForm.errors?.['passwordsMismatch']) {
        <div class="text-danger mt-2">
          As senhas não conferem.
        </div>
      }
    </form>
  </div>

  <!-- Autenticação em Duas Etapas (MFA) -->
  <div class="mb-4">
    <h5>Autenticação em Duas Etapas (MFA)</h5>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="2faSwitch" [(ngModel)]="is2FAEnabled" (change)="toggle2FA()" />
      <label class="form-check-label" for="2faSwitch">
        {{ is2FAEnabled ? 'Desativar' : 'Ativar' }} autenticação em duas etapas
      </label>
    </div>
    @if (is2FAEnabled) {
      <div class="mt-2">
        <small class="text-success">Autenticação em duas etapas está ativada para sua conta.</small>
      </div>
    } @else {
      <div class="mt-2">
        <small class="text-muted">Sua conta está protegida apenas por senha.</small>
      </div>
    }
  </div>

  <!-- Sessões Ativas -->
  <div>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Sessões Ativas</h5>
      @if (activeSessions.length > 1) {
        <button 
          class="btn btn-outline-danger btn-sm"
          (click)="logoutAllSessions()"
          [disabled]="isLoggingOutAll">
          <i class="bi bi-power me-1"></i>
          {{ isLoggingOutAll ? 'Encerrando...' : 'Encerrar todas as sessões' }}
        </button>
      }
    </div>

    <ul class="list-group">
      <li class="list-group-item d-flex justify-content-between align-items-center" *ngFor="let session of activeSessions; let i = index">
        <span>
          <!-- ✅ ÍCONES DIFERENTES POR TIPO DE DEVICE -->
          <i class="bi" [ngClass]="{
            'bi-laptop': session.device.includes('Desktop') || session.device.includes('Windows') || session.device.includes('Mac'),
            'bi-phone': session.device.includes('Mobile') || session.device.includes('iPhone') || session.device.includes('Android'),
            'bi-tablet': session.device.includes('Tablet') || session.device.includes('iPad'),
            'bi-globe': !session.device.includes('Desktop') && !session.device.includes('Windows') && !session.device.includes('Mac') && !session.device.includes('Mobile') && !session.device.includes('iPhone') && !session.device.includes('Android') && !session.device.includes('Tablet') && !session.device.includes('iPad')
          }"></i>
          {{ session.device }} - {{ session.location }} 
          <span class="text-muted">({{ session.lastActive }})</span>
          
          <!-- ✅ BADGE PARA SESSÃO ATUAL -->
          @if (session.isCurrent) {
            <span class="badge bg-success ms-2">Sessão atual</span>
          }
        </span>
        
        <!-- ✅ BOTÃO DESABILITADO PARA SESSÃO ATUAL -->
        @if (session.isCurrent) {
          <span class="text-muted small">Esta sessão</span>
        } @else {
          <button 
            class="btn btn-outline-danger btn-sm" 
            (click)="logoutSession(session.id)"
            [disabled]="session.isLoggingOut">
            <i class="bi bi-x-circle me-1"></i>
            {{ session.isLoggingOut ? 'Encerrando...' : 'Encerrar' }}
          </button>
        }
      </li>
    </ul>
    
    @if (activeSessions.length === 0) {
      <div class="mt-2 text-muted">
        <i class="bi bi-info-circle me-1"></i>
        Nenhuma sessão ativa encontrada.
      </div>
    } @else if (activeSessions.length === 1) {
      <div class="mt-2 text-muted">
        <i class="bi bi-info-circle me-1"></i>
        Apenas sua sessão atual está ativa.
      </div>
    }
  </div>
</div>
@if (showQrModal) {
  <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <app-modal-qrcode
          [modalTitle]="modalTitle"
          [modalMessage]="modalMessage"
          [qrCodeUrl]="qrCodeUrl"
          (closeModalEvent)="closeQrModal()">
        </app-modal-qrcode>
      </div>
    </div>
  </div>
}
@if (showModal) {
  <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <app-modal-sucesso-cadastro
          [modalTitle]="modalTitle"
          [modalMessage]="modalMessage"
          (closeModalEvent)="closeModal()">
        </app-modal-sucesso-cadastro>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" (click)="closeModal()">Fechar</button>
        </div>
      </div>
    </div>
  </div>
}