<app-header></app-header>

<main class="hero-battle-container" [class.dark]="_themeService === 'dark'" [class.light]="_themeService === 'light'">
  <div class="game-wrapper">
    <!-- CABEÃ‡ALHO COM BOTÃƒO DE AJUDA -->
    <div class="game-header">
      <h1 class="game-title">ğŸ† Hero Battle - RPG Ã‰pico</h1>
      <button class="help-btn" (click)="openHelp()" title="Guia Completo do Jogo">
        <span class="help-icon">ğŸ“–</span>
        <span class="help-text">Guia do Jogo</span>
      </button>
    </div>

    <!-- SELEÃ‡ÃƒO DE CLASSE -->
     @if(fase === 'selecao-classe'){
      <div class="class-selection">
        <div class="selection-header">
          <h2>Escolha sua Classe</h2>
          <p class="selection-subtitle">
            Cada classe possui habilidades Ãºnicas e estilos de combate diferentes. 
            <button class="inline-help-btn" (click)="openHelp()">
              ğŸ“– Clique aqui para ver o guia completo
            </button>
          </p>
        </div>
        
        <div class="classes-grid">
          <div *ngFor="let classe of classesDisponiveis" 
              class="class-card" 
              (click)="selecionarClasse(classe)">
            <div class="class-icon">{{ classe.icone }}</div>
            <h3>{{ classe.nome }}</h3>
            <p class="class-description">{{ classe.descricao }}</p>
            <div class="class-stats">
              <div class="stat">â¤ï¸ Vida: {{ classe.statsBase.vida }}</div>
              <div class="stat">âš”ï¸ Ataque: {{ classe.statsBase.ataque }}</div>
              <div class="stat">ğŸ›¡ï¸ Defesa: {{ classe.statsBase.defesa }}</div>
              <div class="stat">âš¡ Velocidade: {{ classe.statsBase.velocidade }}</div>
              <div class="stat">ğŸ”® {{ classe.recurso }}: {{ classe.statsBase.mana }}</div>
            </div>
          </div>
        </div>
      </div>
     }
    

    <!-- INTERFACE DE BATALHA -->
     @if(fase === 'batalha' && jogador){
      <div class="battle-interface">
      
        <!-- INFORMAÃ‡Ã•ES DE PROGRESSO -->
        <div class="progress-info">
          <div class="game-stats">
            <div class="stat-item">
              <span class="stat-label">ğŸ† Score</span>
              <span class="stat-value">{{ gameStats.score | number }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ğŸ¯ Tentativa</span>
              <span class="stat-value">#{{ gameStats.attempts }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">â±ï¸ Tempo</span>
              <span class="stat-value">{{ getTempoJogado() }}</span>
            </div>
          </div>
          
          @if(progressSaving || progressMessage){
            <div class="saving-status">
              @if(progressSaving){
                <div class="saving-indicator">
                  <span class="spinner">â³</span> Salvando progresso...
                </div>
              }
              @if(progressMessage && !progressSaving){
                <div class="success-message">
                  {{ progressMessage }}
                </div>
              }
              
            </div>
          }

          <button 
            class="save-btn" 
            (click)="saveProgress()"
            [disabled]="progressSaving"
            title="Salvar Progresso Manualmente">
            @if(!progressSaving){
              <span>ğŸ’¾ Salvar</span>
            }
            @if(progressSaving){
              <span>â³ Salvando...</span>
            }
          </button>
        </div>

        <!-- HUD DO JOGADOR -->
        <div class="player-hud">
          <div class="character-info">
            <div class="character-avatar">{{ jogador.classe.icone }}</div>
            <div class="character-details">
              <h3>{{ jogador.classe.nome }} - NÃ­vel {{ jogador.stats.nivel }}</h3>
              
              <!-- BARRA DE VIDA -->
              <div class="stat-bar vida-bar">
                <label>â¤ï¸ Vida: {{ jogador.stats.vida }} / {{ jogador.stats.vidaMax }}</label>
                <div class="bar-container">
                  <div class="bar-fill vida" [style.width.%]="getBarraVidaPercent(jogador.stats.vida, jogador.stats.vidaMax)"></div>
                </div>
              </div>

              <!-- BARRA DE MANA/ENERGIA -->
              <div class="stat-bar mana-bar">
                <label>ğŸ”® {{ jogador.classe.recurso }}: {{ jogador.stats.mana }} / {{ jogador.stats.manaMax }}</label>
                <div class="bar-container">
                  <div class="bar-fill mana" [style.width.%]="getBarraManaPercent(jogador.stats.mana, jogador.stats.manaMax)"></div>
                </div>
              </div>

              <!-- EXPERIÃŠNCIA -->
              <div class="stat-bar exp-bar">
                <label>â­ EXP: {{ jogador.stats.experiencia }} / {{ jogador.stats.experienciaProximo }}</label>
                <div class="bar-container">
                  <div class="bar-fill exp" [style.width.%]="getBarraManaPercent(jogador.stats.experiencia, jogador.stats.experienciaProximo)"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ARENA DE BATALHA -->
        <div class="battle-arena">
          <div class="level-info">
            <h2>NÃ­vel {{ nivel }}: {{ inimigo?.nome }}</h2>
            @if(inimigo?.tipo === 'chefe'){
              <p>ğŸ‘‘ CHEFE</p>
            }
          </div>

          <!-- INIMIGO -->
          @if(inimigo){
            <div class="enemy-display">
              <div class="enemy-avatar">{{ inimigo.sprite }}</div>
              <div class="enemy-info">
                <h3>{{ inimigo.nome }}</h3>
                <p class="enemy-description">{{ inimigo.descricao }}</p>
                
                <!-- VIDA DO INIMIGO -->
                <div class="stat-bar enemy-hp">
                  <label>â¤ï¸ Vida: {{ inimigo.vida }} / {{ inimigo.vidaMax }}</label>
                  <div class="bar-container">
                    <div class="bar-fill enemy-vida" [style.width.%]="getBarraVidaPercent(inimigo.vida, inimigo.vidaMax)"></div>
                  </div>
                </div>
              </div>
            </div>
          }

          <!-- INDICADOR DE TURNO -->
          <div class="turn-indicator">
            <div class="turn-info" [class.active]="turno === 'jogador'">
              @if(turno === 'jogador'){
                <span>ğŸ—¡ï¸ SEU TURNO</span>
              }
              @if(turno === 'inimigo'){
                <span>ğŸ¤– Turno do Inimigo...</span>
              }
            </div>
          </div>
        </div>

        <!-- AÃ‡Ã•ES DO JOGADOR -->
        <div class="player-actions" [class.disabled]="turno !== 'jogador'">
          <div class="action-buttons">
            <button class="action-btn attack-btn" 
                    (click)="atacar()" 
                    [disabled]="turno !== 'jogador'">
              âš”ï¸ Atacar
            </button>

            <div class="abilities-section">
              <h4>Habilidades:</h4>
              <div class="abilities-grid">
                <button *ngFor="let habilidade of getHabilidadesDisponiveis()" 
                        class="ability-btn"
                        [class.disabled]="!podeUsarHabilidade(habilidade)"
                        [disabled]="turno !== 'jogador' || !podeUsarHabilidade(habilidade)"
                        (click)="usarHabilidade(habilidade)"
                        [title]="habilidade.descricao">
                  <span class="ability-name">{{ habilidade.nome }}</span>
                  <span class="ability-cost">{{ habilidade.custo }}</span>
                  @if(habilidade.isUltimate){
                    <span class="ultimate-mark">â­</span>
                  }
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- LOG DE COMBATE -->
        <div class="combat-log">
          <h4>ğŸ“œ Log de Combate:</h4>
          <div class="log-messages">
            <div *ngFor="let message of log.slice(-8); let i = index" 
                class="log-message"
                [class.recent]="i >= log.length - 3">
              {{ message }}
            </div>
          </div>
        </div>
      </div>
     }
    

    <!-- TELA DE VITÃ“RIA -->
    @if(fase === 'vitoria'){
      <div class="victory-screen">
        <div class="victory-content">
          <h2>ğŸ‰ VITÃ“RIA!</h2>
          <p>VocÃª derrotou {{ inimigo?.nome }}!</p>
          <div class="victory-rewards">
            <p>ğŸ’° ExperiÃªncia ganha: {{ nivel * 20 }} XP</p>
            <p>â­ NÃ­vel atual: {{ jogador?.stats?.nivel }}</p>
            <p>ğŸ† Score obtido: {{ gameStats.score | number }} pontos</p>
          </div>
          
          <!-- STATUS DE SALVAMENTO -->
          @if(progressSaving || progressMessage){
            <div class="save-status">
              @if(progressSaving){
                <div class="saving-progress">
                  <span class="spinner">â³</span> Salvando seu progresso...
                </div>
              }
              @if(progressMessage && !progressSaving){
                <div class="save-success">
                  âœ… {{ progressMessage }}
                </div>
              }
              
            </div>
          }

          <div class="victory-actions">
            <button class="btn-primary" 
                    (click)="proximoNivel()"
                    [disabled]="progressSaving">
              @if(!progressSaving){
                <span>â¡ï¸ PrÃ³ximo NÃ­vel</span>
              }
              @if(progressSaving){
                <span>â³ Aguarde...</span>
              }
            </button>
            <button class="btn-secondary" (click)="reiniciarJogo()">
              ğŸ”„ RecomeÃ§ar
            </button>
          </div>
        </div>
      </div>
    }
    

    <!-- TELA DE LEVEL UP -->
    @if(fase === 'level-up'){
      <div class="levelup-screen">
        <div class="levelup-content">
          <h2>â­ LEVEL UP!</h2>
          <p>ParabÃ©ns! VocÃª subiu para o nÃ­vel {{ jogador?.stats?.nivel }}!</p>
          <div class="stat-improvements">
            <div class="improvement">â¤ï¸ Vida MÃ¡xima: +10</div>
            <div class="improvement">âš”ï¸ Ataque: +3</div>
            <div class="improvement">ğŸ›¡ï¸ Defesa: +2</div>
            <div class="improvement">ğŸ”® Mana MÃ¡xima: +10</div>
          </div>
          <button class="btn-primary" (click)="proximoNivel()">
            âœ¨ Continuar
          </button>
        </div>
      </div>
    }

    <!-- TELA DE DERROTA -->
    @if(fase === 'derrota'){
      <div class="defeat-screen">
        <div class="defeat-content">
          <h2>ğŸ’€ DERROTA</h2>
          <p>VocÃª foi derrotado por {{ inimigo?.nome }}...</p>
          <p>NÃ£o desista! Tente novamente!</p>
          
          <!-- ESTATÃSTICAS DA TENTATIVA -->
          <div class="defeat-stats">
            <p>ğŸ“Š EstatÃ­sticas desta tentativa:</p>
            <div class="stats-grid">
              <div class="stat-item">
                <span>ğŸ† Score Final:</span>
                <span>{{ gameStats.score | number }}</span>
              </div>
              <div class="stat-item">
                <span>â±ï¸ Tempo Jogado:</span>
                <span>{{ getTempoJogado() }}</span>
              </div>
              <div class="stat-item">
                <span>ğŸ¯ NÃ­vel AlcanÃ§ado:</span>
                <span>{{ nivel }}</span>
              </div>
            </div>
          </div>

          <div class="defeat-actions">
            <button class="btn-primary" (click)="reiniciarJogo()">
              ğŸ”„ Tentar Novamente
            </button>
          </div>
        </div>
      </div>
    }
    
  </div>
</main>

<app-game-help-modal 
  [isOpen]="showHelpModal" 
  (closeModal)="closeHelp()">
</app-game-help-modal>

<app-footer></app-footer>