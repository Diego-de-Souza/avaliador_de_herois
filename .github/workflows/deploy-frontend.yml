name: Deploy Frontend to AWS

on:
  # OpÃ§Ã£o 1: Deploy automÃ¡tico apenas na branch main/master
  push:
    branches:
      - main
      - master
  
  # OpÃ§Ã£o 2: Deploy em qualquer branch (descomente para ativar)
  # push:
  #   branches:
  #     - '*'  # Qualquer branch
  
  # OpÃ§Ã£o 3: Deploy apenas manual (descomente para ativar)
  # workflow_dispatch:
  
  # OpÃ§Ã£o 4: Deploy quando criar uma tag de release (descomente para ativar)
  # release:
  #   types: [published]

env:
  AWS_REGION: us-east-1
  FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}
  SSH_HOST: ${{ vars.SSH_HOST || vars.FRONTEND_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /var/www/app
  SSH_PORT: ${{ vars.SSH_PORT || '22' }}
  SSH_TIMEOUT: 30

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate required secrets and variables
        run: |
          if [ -z "${{ vars.FRONTEND_HOST }}" ]; then
            echo "Error: FRONTEND_HOST variable is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "All required secrets and variables are set"
          echo "FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}"
          echo "SSH_HOST: ${{ env.SSH_HOST }} (for SSH connection)"
          echo "SSH_PORT: ${{ env.SSH_PORT }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run unit tests
        run: npm run test:ci
        continue-on-error: false  # Falha o deploy se testes falharem
        env:
          CI: true
          # VariÃ¡veis de ambiente para o mock do environment nos testes
          API_URL: ${{ secrets.API_URL || 'http://localhost:3020/api' }}
          ID_CLIENTE_GOOGLE: ${{ secrets.ID_CLIENTE_GOOGLE || '' }}
          SECRET_KEY_GOOGLE: ${{ secrets.SECRET_KEY_GOOGLE || '' }}
          STRIPE_PUBLIC_KEY: ${{ secrets.STRIPE_PUBLIC_KEY || '' }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY || '' }}

      - name: Build application
        # Angular build com variÃ¡veis de ambiente
        run: npm run build
        env:
          NODE_ENV: production
          # VariÃ¡veis de ambiente necessÃ¡rias para o prebuild (scripts/generate-env.js)
          API_URL: ${{ secrets.API_URL }}
          ID_CLIENTE_GOOGLE: ${{ secrets.ID_CLIENTE_GOOGLE }}
          SECRET_KEY_GOOGLE: ${{ secrets.SECRET_KEY_GOOGLE }}
          STRIPE_PUBLIC_KEY: ${{ secrets.STRIPE_PUBLIC_KEY }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Configurar opÃ§Ãµes SSH padrÃ£o
          # Usa SSH_HOST (pode ser IP ou subdomÃ­nio sem Cloudflare) para conexÃ£o SSH
          # mas mantÃ©m o alias do FRONTEND_HOST para facilitar o uso
          cat > ~/.ssh/config << EOF
          Host ${{ env.FRONTEND_HOST }}
            HostName ${{ env.SSH_HOST }}
            Port ${{ env.SSH_PORT }}
            User ${{ env.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout ${{ env.SSH_TIMEOUT }}
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
          chmod 600 ~/.ssh/config
          
          # Teste de conectividade bÃ¡sico usando timeout (disponÃ­vel no Ubuntu)
          echo "Testing connection to ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}..."
          echo "Running connectivity test..."
          if timeout 10 bash -c "cat < /dev/null > /dev/tcp/${{ env.SSH_HOST }}/${{ env.SSH_PORT }}" 2>/dev/null; then
            echo "âœ… Port ${{ env.SSH_PORT }} is open and reachable"
          else
            echo "âŒ Port ${{ env.SSH_PORT }} test failed"
            echo "This usually means:"
            echo "  - The port is blocked by AWS Security Group"
            echo "  - The port is blocked by server firewall (ufw/iptables)"
            echo "  - The server is in a private subnet without public IP"
            echo "  - The SSH service is not running on the server"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Check AWS Security Group - allow inbound SSH (port 22) from 0.0.0.0/0 or GitHub Actions IPs"
            echo "2. Check server firewall: sudo ufw status (should allow port 22)"
            echo "3. Verify SSH service: sudo systemctl status sshd"
            echo "4. Check if server has public IP: curl ifconfig.me on the server"
          fi
          
          # Adiciona o host ao known_hosts usando o SSH_HOST real
          if [ -n "${{ env.SSH_HOST }}" ]; then
            ssh-keyscan -p ${{ env.SSH_PORT }} -H "${{ env.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || echo "Warning: Could not add host to known_hosts, but continuing..."
            chmod 644 ~/.ssh/known_hosts
          fi

      - name: Copy files to EC2
        run: |
          # Teste de conexÃ£o SSH antes de continuar
          echo "Testing SSH connection to ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}..."
          ssh -F ~/.ssh/config ${{ env.FRONTEND_HOST }} "echo 'SSH connection successful'" || {
          echo ""
          echo "âŒ ERROR: Cannot connect to ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}"
          echo ""
          echo "The connection is timing out. This means the IP is reachable but port ${{ env.SSH_PORT }} is blocked or not responding."
          echo ""
          echo "ðŸ” Most likely causes:"
          echo ""
          echo "1. AWS Security Group blocking port 22"
          echo "   â†’ Go to EC2 Console â†’ Security Groups â†’ Select your instance's security group"
          echo "   â†’ Add Inbound Rule: Type=SSH, Port=22, Source=0.0.0.0/0 (or GitHub Actions IPs)"
          echo ""
          echo "2. Server firewall blocking port 22"
          echo "   â†’ SSH to the server (if you have another way) and run:"
          echo "     sudo ufw allow 22/tcp"
          echo "     sudo ufw reload"
          echo "   â†’ Or check iptables: sudo iptables -L -n"
          echo ""
          echo "3. SSH service not running"
          echo "   â†’ On the server, check: sudo systemctl status sshd"
          echo "   â†’ Start if needed: sudo systemctl start sshd"
          echo ""
          echo "4. Server in private subnet"
          echo "   â†’ If server is in a private subnet, you need a bastion host"
          echo "   â†’ Or assign a public IP to the instance"
          echo ""
          echo "5. Wrong SSH port"
          echo "   â†’ If SSH is on a different port, set SSH_PORT variable in GitHub"
          echo ""
          echo "Current configuration:"
          echo "  SSH_HOST: ${{ env.SSH_HOST }}"
          echo "  SSH_PORT: ${{ env.SSH_PORT }}"
          echo "  SSH_USER: ${{ env.SSH_USER }}"
          echo ""
          echo "ðŸ’¡ Quick test from your local machine:"
          echo "   ssh -v ${{ env.SSH_USER }}@${{ env.SSH_HOST }} -p ${{ env.SSH_PORT }}"
          exit 1
          }
          
          # Limpar diretÃ³rio antigo (opcional - mantÃ©m backup)
          ssh -F ~/.ssh/config ${{ env.FRONTEND_HOST }} \
            "sudo mkdir -p ${{ env.APP_DIR }}.backup && sudo cp -r ${{ env.APP_DIR }}/* ${{ env.APP_DIR }}.backup/ 2>/dev/null || true"
          
          # Enviar novos arquivos (output path do Angular: dist/avaliador_de_herois)
          rsync -avz -e "ssh -F ~/.ssh/config" \
            --delete \
            ./dist/avaliador_de_herois/ ${{ env.FRONTEND_HOST }}:/tmp/app/

      - name: Move files and set permissions
        run: |
          ssh -F ~/.ssh/config ${{ env.FRONTEND_HOST }} << 'EOF'
            sudo rm -rf ${{ env.APP_DIR }}/*
            sudo mv /tmp/app/* ${{ env.APP_DIR }}/
            sudo chown -R nginx:nginx ${{ env.APP_DIR }}
            sudo chmod -R 755 ${{ env.APP_DIR }}
            sudo systemctl reload nginx
          EOF

      - name: Health check
        run: |
          sleep 5
          curl -f http://${{ env.FRONTEND_HOST }} || exit 0  # NÃ£o falha se ainda nÃ£o estiver acessÃ­vel

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
