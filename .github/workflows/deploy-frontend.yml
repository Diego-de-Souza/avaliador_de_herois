name: Deploy Frontend to AWS

on:
  # Opção 1: Deploy automático apenas na branch main/master
  push:
    branches:
      - main
      - master
  
  # Opção 2: Deploy em qualquer branch (descomente para ativar)
  # push:
  #   branches:
  #     - '*'  # Qualquer branch
  
  # Opção 3: Deploy apenas manual (descomente para ativar)
  # workflow_dispatch:
  
  # Opção 4: Deploy quando criar uma tag de release (descomente para ativar)
  # release:
  #   types: [published]

env:
  AWS_REGION: us-east-1
  FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /var/www/app
  SSH_PORT: ${{ vars.SSH_PORT || '22' }}
  SSH_TIMEOUT: 30

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate required secrets and variables
        run: |
          if [ -z "${{ vars.FRONTEND_HOST }}" ]; then
            echo "Error: FRONTEND_HOST variable is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "All required secrets and variables are set"
          echo "FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run unit tests
        run: npm run test:ci
        continue-on-error: false  # Falha o deploy se testes falharem
        env:
          CI: true
          # Variáveis de ambiente para o mock do environment nos testes
          API_URL: ${{ secrets.API_URL || 'http://localhost:3020/api' }}
          ID_CLIENTE_GOOGLE: ${{ secrets.ID_CLIENTE_GOOGLE || '' }}
          SECRET_KEY_GOOGLE: ${{ secrets.SECRET_KEY_GOOGLE || '' }}
          STRIPE_PUBLIC_KEY: ${{ secrets.STRIPE_PUBLIC_KEY || '' }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY || '' }}

      - name: Build application
        # Angular build com variáveis de ambiente
        run: npm run build
        env:
          NODE_ENV: production
          # Variáveis de ambiente necessárias para o prebuild (scripts/generate-env.js)
          API_URL: ${{ secrets.API_URL }}
          ID_CLIENTE_GOOGLE: ${{ secrets.ID_CLIENTE_GOOGLE }}
          SECRET_KEY_GOOGLE: ${{ secrets.SECRET_KEY_GOOGLE }}
          STRIPE_PUBLIC_KEY: ${{ secrets.STRIPE_PUBLIC_KEY }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Configurar opções SSH padrão
          cat > ~/.ssh/config << EOF
          Host ${{ env.FRONTEND_HOST }}
            HostName ${{ env.FRONTEND_HOST }}
            Port ${{ env.SSH_PORT }}
            User ${{ env.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout ${{ env.SSH_TIMEOUT }}
            ServerAliveInterval 60
            ServerAliveCountMax 3
          EOF
          chmod 600 ~/.ssh/config
          
          # Teste de conectividade básico usando timeout (disponível no Ubuntu)
          echo "Testing connection to ${{ env.FRONTEND_HOST }}:${{ env.SSH_PORT }}..."
          timeout 5 bash -c "cat < /dev/null > /dev/tcp/${{ env.FRONTEND_HOST }}/${{ env.SSH_PORT }}" 2>/dev/null && echo "Port ${{ env.SSH_PORT }} is open" || echo "Warning: Port ${{ env.SSH_PORT }} test failed, but continuing..."
          
          # Adiciona o host ao known_hosts apenas se FRONTEND_HOST estiver definido
          # Como usamos StrictHostKeyChecking=no, isso é apenas uma otimização
          if [ -n "${{ vars.FRONTEND_HOST }}" ]; then
            ssh-keyscan -p ${{ env.SSH_PORT }} -H "${{ vars.FRONTEND_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || echo "Warning: Could not add host to known_hosts, but continuing..."
            chmod 644 ~/.ssh/known_hosts
          else
            echo "FRONTEND_HOST not set, skipping ssh-keyscan (using StrictHostKeyChecking=no)"
          fi

      - name: Copy files to EC2
        run: |
          # Teste de conexão SSH antes de continuar
          echo "Testing SSH connection..."
          ssh -F ~/.ssh/config ${{ env.FRONTEND_HOST }} "echo 'SSH connection successful'" || {
            echo "ERROR: Cannot connect to ${{ env.FRONTEND_HOST }}:${{ env.SSH_PORT }}"
            echo "Please verify:"
            echo "  1. The server is accessible from the internet"
            echo "  2. SSH port (${{ env.SSH_PORT }}) is open in the firewall"
            echo "  3. The SSH_PRIVATE_KEY matches the public key on the server"
            echo "  4. The server allows connections from GitHub Actions IPs"
            exit 1
          }
          
          # Limpar diretório antigo (opcional - mantém backup)
          ssh -F ~/.ssh/config ${{ env.FRONTEND_HOST }} \
            "sudo mkdir -p ${{ env.APP_DIR }}.backup && sudo cp -r ${{ env.APP_DIR }}/* ${{ env.APP_DIR }}.backup/ 2>/dev/null || true"
          
          # Enviar novos arquivos (output path do Angular: dist/avaliador_de_herois)
          rsync -avz -e "ssh -F ~/.ssh/config" \
            --delete \
            ./dist/avaliador_de_herois/ ${{ env.FRONTEND_HOST }}:/tmp/app/

      - name: Move files and set permissions
        run: |
          ssh -F ~/.ssh/config ${{ env.FRONTEND_HOST }} << 'EOF'
            sudo rm -rf ${{ env.APP_DIR }}/*
            sudo mv /tmp/app/* ${{ env.APP_DIR }}/
            sudo chown -R nginx:nginx ${{ env.APP_DIR }}
            sudo chmod -R 755 ${{ env.APP_DIR }}
            sudo systemctl reload nginx
          EOF

      - name: Health check
        run: |
          sleep 5
          curl -f http://${{ env.FRONTEND_HOST }} || exit 0  # Não falha se ainda não estiver acessível

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
