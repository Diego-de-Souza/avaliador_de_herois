name: Deploy Frontend to AWS

on:
  push:
    branches:
      - main
      - master

env:
  AWS_REGION: us-east-1
  FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}
  SSH_HOST: ${{ vars.SSH_HOST || vars.FRONTEND_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /var/www/app
  SSH_PORT: ${{ vars.SSH_PORT || '22' }}
  SSH_TIMEOUT: 30
  SSL_EMAIL: plataformaheroes20250820@gmail.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate required secrets and variables
        run: |
          if [ -z "${{ vars.FRONTEND_HOST }}" ]; then
            echo "Error: FRONTEND_HOST variable is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "All required secrets and variables are set"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Angular Environment Files
        env:
          API_URL: ${{ vars.API_URL || 'https://api.heroesplatform.com.br' }}
          ID_CLIENTE_GOOGLE: ${{ vars.ID_CLIENTE_GOOGLE || '' }}
          SECRET_KEY_GOOGLE: ${{ secrets.SECRET_KEY_GOOGLE || '' }}
          STRIPE_PUBLIC_KEY: ${{ vars.STRIPE_PUBLIC_KEY || '' }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY || '' }}
        run: |
          echo "üîß Configurando environment do Angular..."
          echo "API_URL: $API_URL"
          
          mkdir -p src/environments
          
          if [ -f "scripts/generate-environment.js" ]; then
            echo "üì¶ Usando script generate-environment.js..."
            API_URL="$API_URL" \
            ID_CLIENTE_GOOGLE="$ID_CLIENTE_GOOGLE" \
            SECRET_KEY_GOOGLE="$SECRET_KEY_GOOGLE" \
            STRIPE_PUBLIC_KEY="$STRIPE_PUBLIC_KEY" \
            ENCRYPTION_KEY="$ENCRYPTION_KEY" \
            node scripts/generate-environment.js
          else
            echo "üì¶ Gerando environment files diretamente..."
            
            cat > src/environments/environment.prod.ts << 'EOF'
            export const environment = {
              production: true,
              apiURL: '$API_URL',
              ID_CLIENTE_GOOGLE: '$ID_CLIENTE_GOOGLE',
              SECRET_KEY_GOOGLE: '$SECRET_KEY_GOOGLE',
              stripePublicKey: '$STRIPE_PUBLIC_KEY',
              encryptionKey: '$ENCRYPTION_KEY'
            };
            EOF
            
            cat > src/environments/environment.ts << 'EOF'
            export const environment = {
              production: false,
              apiURL: '$API_URL',
              ID_CLIENTE_GOOGLE: '$ID_CLIENTE_GOOGLE',
              SECRET_KEY_GOOGLE: '$SECRET_KEY_GOOGLE',
              stripePublicKey: '$STRIPE_PUBLIC_KEY',
              encryptionKey: '$ENCRYPTION_KEY'
            };
            EOF
          fi
          
          echo "‚úÖ Arquivos de environment criados"
          
          # Verificar apiURL n√£o est√° vazio
          if grep -q "apiURL: ''" src/environments/environment.prod.ts || \
             grep -q 'apiURL: ""' src/environments/environment.prod.ts; then
            echo "‚ùå ERRO: apiURL est√° VAZIO! Corrigindo..."
            sed -i "s|apiURL:.*|apiURL: 'https://api.heroesplatform.com.br',|" src/environments/environment.prod.ts
            sed -i "s|apiURL:.*|apiURL: 'https://api.heroesplatform.com.br',|" src/environments/environment.ts
            echo "‚úÖ Valor corrigido"
          fi

      - name: Build application
        env:
          API_URL: ${{ vars.API_URL || 'https://api.heroesplatform.com.br' }}
        run: |
          echo "üèóÔ∏è  Iniciando build Angular..."
          npm run build
          
          if [ ! -d "./dist" ]; then
            echo "‚ùå ERROR: Pasta dist n√£o foi criada!"
            exit 1
          fi
          
          echo "‚úÖ Build conclu√≠do"

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          cat > ~/.ssh/config << EOF
          Host ${{ env.FRONTEND_HOST }}
            HostName ${{ env.SSH_HOST }}
            Port ${{ env.SSH_PORT }}
            User ${{ env.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF

      - name: Copy files to EC2
        run: |
          SSH_KEY="$HOME/.ssh/deploy_key"
          
          # Encontrar diret√≥rio do build
          BUILD_SRC=""
          if [ -d "./dist/avaliador_de_herois/browser" ]; then
            BUILD_SRC="./dist/avaliador_de_herois/browser"
          else
            INDEX_PATH=$(find ./dist -name "index.html" | head -1)
            if [ -n "$INDEX_PATH" ]; then
              BUILD_SRC=$(dirname "$INDEX_PATH")
            else
              echo "‚ùå ERROR: N√£o encontrado index.html em dist/"
              exit 1
            fi
          fi
          
          echo "‚úÖ Build encontrado em: $BUILD_SRC"
          
          # Verificar e corrigir localhost antes de copiar
          if grep -r "localhost:3020" "$BUILD_SRC" 2>/dev/null; then
            echo "‚ö†Ô∏è  Corrigindo localhost no build..."
            find "$BUILD_SRC" -name "*.js" -type f -exec sed -i \
              "s|http://localhost:3020|https://api.heroesplatform.com.br|g" {} \;
          fi
          
          # Criar e copiar tar
          tar czf /tmp/app-build.tar.gz -C "$BUILD_SRC" .
          
          scp -i "$SSH_KEY" \
            -o StrictHostKeyChecking=no \
            -P ${{ env.SSH_PORT }} \
            /tmp/app-build.tar.gz \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/tmp/
          
          # Extrair no servidor
          ssh -i "$SSH_KEY" \
            -o StrictHostKeyChecking=no \
            -p ${{ env.SSH_PORT }} \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
            sudo rm -rf /tmp/app-build
            sudo mkdir -p /tmp/app-build
            sudo tar xzf /tmp/app-build.tar.gz -C /tmp/app-build
            sudo rm -f /tmp/app-build.tar.gz
            echo '‚úÖ Arquivos extra√≠dos'
          "
          
          rm -f /tmp/app-build.tar.gz

      - name: Deploy to server with SSL
        run: |
          SSH_KEY="$HOME/.ssh/deploy_key"
          
          # Script de deploy COMPLETO com SSL
          ssh -i "$SSH_KEY" \
            -o StrictHostKeyChecking=no \
            -p ${{ env.SSH_PORT }} \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} '
          # 1. Verificar arquivos
          if [ ! -d "/tmp/app-build" ] || [ -z "$(ls -A /tmp/app-build)" ]; then
            echo "‚ùå ERROR: /tmp/app-build n√£o existe ou est√° vazio!"
            exit 1
          fi
          
          echo "‚úÖ Arquivos recebidos"
          
          # 2. Corrigir localhost se necess√°rio
          echo "üîç Verificando localhost no build..."
          if grep -r "localhost" /tmp/app-build/*.js 2>/dev/null; then
            echo "‚ö†Ô∏è  Corrigindo localhost..."
            sudo find /tmp/app-build -name "*.js" -type f -exec sed -i \
              -e "s|http://localhost:3020|https://api.heroesplatform.com.br|g" \
              -e "s|localhost:3020|api.heroesplatform.com.br|g" \
              {} \;
            echo "‚úÖ localhost corrigido"
          fi
          
          # 3. Mover arquivos
          sudo mkdir -p /var/www/app/browser
          sudo rm -rf /var/www/app/browser/*
          sudo cp -r /tmp/app-build/* /var/www/app/browser/
          
          # 4. Permiss√µes
          sudo chown -R nginx:nginx /var/www/app
          sudo chmod -R 755 /var/www/app
          
          echo "‚úÖ Arquivos copiados e permiss√µes configuradas"
          
          # 5. CONFIGURA√á√ÉO NGINX COM SSL
          echo "üîß Configurando Nginx com SSL..."
          
          # Primeiro, configurar HTTP (ser√° atualizado pelo Certbot)
          sudo tee /etc/nginx/conf.d/heroesplatform.conf > /dev/null << "EOF"
          server {
              listen 80;
              listen [::]:80;
              server_name heroesplatform.com.br www.heroesplatform.com.br;
              
              root /var/www/app/browser;
              index index.html;
              
              access_log /var/log/nginx/heroesplatform-access.log;
              error_log /var/log/nginx/heroesplatform-error.log;
              
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
              
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
              
              location / {
                  try_files $uri $uri/ /index.html;
                  
                  location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }
              
              location ~ /\. {
                  deny all;
                  access_log off;
                  log_not_found off;
              }
              
              location /api/ {
                  proxy_pass http://100.52.213.205:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
              
              # Para certificado SSL - ser√° usado pelo Certbot
              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }
          }
          EOF
          
          # 6. Testar Nginx
          if sudo nginx -t; then
            echo "‚úÖ Configura√ß√£o Nginx HTTP v√°lida"
            sudo systemctl reload nginx
            echo "‚úÖ Nginx recarregado"
          else
            echo "‚ùå ERROR: Configura√ß√£o Nginx inv√°lida"
            sudo nginx -t
            exit 1
          fi
          
          # 7. INSTALAR SSL COM CERTBOT
          echo "üîê Instalando certificado SSL..."
          
          # Verificar se certbot est√° instalado
          if ! command -v certbot &> /dev/null; then
            echo "üì¶ Instalando Certbot..."
            sudo dnf install -y certbot python3-certbot-nginx
          fi
          
          # Executar Certbot
          echo "üìù Solicitando certificado SSL..."
          if sudo certbot --nginx \
            -d heroesplatform.com.br \
            -d www.heroesplatform.com.br \
            --non-interactive \
            --agree-tos \
            --email '${{ env.SSL_EMAIL }}' \
            --redirect; then
            echo "‚úÖ Certificado SSL instalado com sucesso!"
            
            # Verificar certificado
            echo "üìã Verificando certificado:"
            sudo certbot certificates | grep -A5 "heroesplatform"
          else
            echo "‚ö†Ô∏è  Certbot falhou, continuando sem SSL..."
            echo "üí° Execute manualmente depois:"
            echo "   sudo certbot --nginx -d heroesplatform.com.br -d www.heroesplatform.com.br --non-interactive --agree-tos -m ${{ env.SSL_EMAIL }}"
          fi
          
          # 8. Verificar configura√ß√£o SSL final
          echo "üîç Verificando configura√ß√£o final..."
          if sudo nginx -t; then
            sudo systemctl reload nginx
            echo "‚úÖ Nginx com SSL recarregado"
          else
            echo "‚ö†Ô∏è  Problema na configura√ß√£o SSL, recarregando HTTP apenas..."
            sudo systemctl reload nginx
          fi
          
          # 9. Testar site
          echo "üåê Testando site..."
          echo "Teste HTTP:"
          curl -s -H "Host: heroesplatform.com.br" -I http://localhost | head -1
          echo "Teste HTTPS (pode falhar se Certbot falhou):"
          curl -sk -H "Host: heroesplatform.com.br" -I https://localhost 2>/dev/null | head -1 || echo "HTTPS n√£o dispon√≠vel"
          
          # 10. Limpar
          sudo rm -rf /tmp/app-build
          
          echo "üöÄ DEPLOY CONCLU√çDO! Site acess√≠vel em:"
          echo "   üåê http://heroesplatform.com.br"
          echo "   üîí https://heroesplatform.com.br (se SSL instalado)"
          '

      - name: Verify deployment
        run: |
          sleep 5
          echo "üîç Verifica√ß√£o externa..."
          echo "Testando HTTP:"
          curl -s -I "http://${{ env.FRONTEND_HOST }}" || echo "HTTP ainda n√£o respondendo"
          echo ""
          echo "Testando HTTPS:"
          curl -sk -I "https://${{ env.FRONTEND_HOST }}" 2>/dev/null | head -1 || echo "HTTPS n√£o dispon√≠vel ainda"
          echo ""
          echo "‚úÖ Processo de deploy completo"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key