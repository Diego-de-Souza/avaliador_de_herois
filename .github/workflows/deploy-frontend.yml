name: Deploy Frontend to AWS

on:
  push:
    branches:
      - main
      - master

env:
  AWS_REGION: us-east-1
  FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}
  SSH_HOST: ${{ vars.SSH_HOST || vars.FRONTEND_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /var/www/app
  SSH_PORT: ${{ vars.SSH_PORT || '22' }}
  SSH_TIMEOUT: 30

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate required secrets and variables
        run: |
          if [ -z "${{ vars.FRONTEND_HOST }}" ]; then
            echo "Error: FRONTEND_HOST variable is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ vars.API_URL }}" ]; then
            echo "Warning: API_URL variable is not set. Using default: https://api.heroesplatform.com.br"
          fi
          echo "All required secrets and variables are set"
          echo "FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}"
          echo "SSH_HOST: ${{ env.SSH_HOST }} (for SSH connection)"
          echo "SSH_PORT: ${{ env.SSH_PORT }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run unit tests
        run: npm run test:ci
        continue-on-error: false
        env:
          CI: true
          API_URL: ${{ vars.API_URL || 'http://localhost:3020/api' }}
          ID_CLIENTE_GOOGLE: ${{ vars.ID_CLIENTE_GOOGLE || '' }}
          SECRET_KEY_GOOGLE: ${{ secrets.SECRET_KEY_GOOGLE || '' }}
          STRIPE_PUBLIC_KEY: ${{ vars.STRIPE_PUBLIC_KEY || '' }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY || '' }}

      - name: Generate Angular Environment Files
        run: |
          echo "ðŸ”§ Configurando environment do Angular..."
          
          # Criar diretÃ³rio se nÃ£o existir
          mkdir -p src/environments
          
          # Criar environment.prod.ts
          cat > src/environments/environment.prod.ts << 'ENVPROD_EOF'
          export const environment = {
            production: true,
            apiURL: '${{ vars.API_URL || 'https://api.heroesplatform.com.br' }}',
            ID_CLIENTE_GOOGLE: '${{ vars.ID_CLIENTE_GOOGLE || '' }}',
            SECRET_KEY_GOOGLE: '${{ secrets.SECRET_KEY_GOOGLE || '' }}',
            stripePublicKey: '${{ vars.STRIPE_PUBLIC_KEY || '' }}',
            encryptionKey: '${{ secrets.ENCRYPTION_KEY || '' }}'
          };
          ENVPROD_EOF
          
          # Criar environment.ts
          cat > src/environments/environment.ts << 'ENVDEV_EOF'
          export const environment = {
            production: false,
            apiURL: '${{ vars.API_URL || 'https://api.heroesplatform.com.br' }}',
            ID_CLIENTE_GOOGLE: '${{ vars.ID_CLIENTE_GOOGLE || '' }}',
            SECRET_KEY_GOOGLE: '${{ secrets.SECRET_KEY_GOOGLE || '' }}',
            stripePublicKey: '${{ vars.STRIPE_PUBLIC_KEY || '' }}',
            encryptionKey: '${{ secrets.ENCRYPTION_KEY || '' }}'
          };
          ENVDEV_EOF
          
          echo "âœ… Arquivos de environment criados"
          echo "API_URL definido como: ${{ vars.API_URL || 'https://api.heroesplatform.com.br' }}"

      - name: Force Replace localhost References
        run: |
          echo "ðŸ” Procurando e substituindo referÃªncias a localhost:3020..."
          
          API_URL="${{ vars.API_URL || 'https://api.heroesplatform.com.br' }}"
          
          # Substituir em arquivos TypeScript/JavaScript
          find src -type f \( -name "*.ts" -o -name "*.js" -o -name "*.html" \) -exec grep -l "localhost:3020" {} \; 2>/dev/null | while read file; do
            echo "ðŸ”§ Corrigindo: $file"
            sed -i "s|http://localhost:3020|${API_URL}|g" "$file"
            sed -i "s|localhost:3020|${API_URL}|g" "$file"
          done
          
          echo "âœ… SubstituiÃ§Ã£o concluÃ­da"
          
          # VerificaÃ§Ã£o
          echo "ðŸ“‹ VerificaÃ§Ã£o final:"
          REMAINING_REFS=$(grep -r "localhost:3020" src/ 2>/dev/null | wc -l)
          if [ "$REMAINING_REFS" -gt 0 ]; then
            echo "âš ï¸  Ainda hÃ¡ $REMAINING_REFS referÃªncias a localhost:3020"
            grep -r "localhost:3020" src/ 2>/dev/null | head -5
          else
            echo "âœ… Nenhuma referÃªncia a localhost:3020 encontrada"
          fi

      - name: Build application
        run: npm run build -- --configuration=production
        env:
          NODE_ENV: production

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Corrigir formataÃ§Ã£o da chave
          sed -i 's/\\n/\n/g' ~/.ssh/deploy_key
          sed -i 's/\r$//' ~/.ssh/deploy_key
          echo "" >> ~/.ssh/deploy_key
          
          # Configurar SSH
          cat > ~/.ssh/config << 'SSHCONFIG_EOF'
          Host ${{ env.FRONTEND_HOST }}
            HostName ${{ env.SSH_HOST }}
            Port ${{ env.SSH_PORT }}
            User ${{ env.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout ${{ env.SSH_TIMEOUT }}
            ServerAliveInterval 60
            ServerAliveCountMax 3
          SSHCONFIG_EOF
          chmod 600 ~/.ssh/config
          
          # Teste de conectividade
          echo "Testing connection to ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}..."
          if timeout 10 bash -c "cat < /dev/null > /dev/tcp/${{ env.SSH_HOST }}/${{ env.SSH_PORT }}" 2>/dev/null; then
            echo "âœ… Port ${{ env.SSH_PORT }} is open and reachable"
          else
            echo "âŒ Port ${{ env.SSH_PORT }} test failed"
            echo "Verifique o Security Group no AWS Console"
          fi
          
          # Adicionar host conhecido
          if [ -n "${{ env.SSH_HOST }}" ]; then
            ssh-keyscan -p ${{ env.SSH_PORT }} -H "${{ env.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || echo "Warning: Could not add host to known_hosts"
            chmod 644 ~/.ssh/known_hosts
          fi

      - name: Test SSH Connection
        run: |
          echo "Testing SSH connection to ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}..."
          
          SSH_CONFIG_PATH="$HOME/.ssh/config"
          SSH_CONNECTION_FAILED=false
          
          if [ -f "$SSH_CONFIG_PATH" ]; then
            echo "âœ… SSH config encontrado. Testando conexÃ£o..."
            timeout 30 ssh -F "$SSH_CONFIG_PATH" ${{ env.FRONTEND_HOST }} "echo 'âœ… SSH connection successful'; hostname" || SSH_CONNECTION_FAILED=true
          else
            echo "âš ï¸  SSH config nÃ£o encontrado, usando mÃ©todo alternativo..."
            timeout 30 ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "echo 'âœ… SSH connection successful'; hostname" || SSH_CONNECTION_FAILED=true
          fi
          
          if [ "$SSH_CONNECTION_FAILED" = true ]; then
            echo ""
            echo "âŒ ERROR: Cannot connect to ${{ env.SSH_HOST }}:${{ env.SSH_PORT }}"
            echo ""
            echo "Tente conectar manualmente para diagnÃ³stico:"
            echo "  ssh -v -i ~/.ssh/deploy_key ${{ env.SSH_USER }}@${{ env.SSH_HOST }} -p ${{ env.SSH_PORT }}"
            exit 1
          fi
          
          echo "âœ… SSH connection successful!"

      - name: Copy files to EC2
        run: |
          echo "ðŸ“‚ Iniciando cÃ³pia de arquivos para o servidor..."
          
          # Verificar se a pasta dist existe
          if [ ! -d "./dist/avaliador_de_herois" ]; then
            echo "âŒ ERROR: Pasta dist/avaliador_de_herois nÃ£o encontrada!"
            exit 1
          fi
          
          if [ -z "$(ls -A ./dist/avaliador_de_herois)" ]; then
            echo "âŒ ERROR: Pasta dist/avaliador_de_herois estÃ¡ vazia!"
            exit 1
          fi
          
          echo "âœ… Build encontrado com arquivos. Copiando..."
          
          SSH_CONFIG_PATH="$HOME/.ssh/config"
          
          # Usar mÃ©todo mais confiÃ¡vel: tar + scp
          echo "ðŸ“¦ Criando pacote para envio..."
          cd dist && tar czf app.tar.gz avaliador_de_herois/ && cd ..
          
          # Copiar para servidor
          if [ -f "$SSH_CONFIG_PATH" ]; then
            echo "Usando SSH config para copiar..."
            scp -F "$SSH_CONFIG_PATH" ./dist/app.tar.gz ${{ env.FRONTEND_HOST }}:/tmp/app.tar.gz
          else
            echo "Usando mÃ©todo alternativo para copiar..."
            scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -P ${{ env.SSH_PORT }} ./dist/app.tar.gz ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/tmp/app.tar.gz
          fi
          
          if [ $? -eq 0 ]; then
            echo "âœ… Pacote copiado com sucesso"
            rm -f ./dist/app.tar.gz
          else
            echo "âŒ Falha ao copiar pacote"
            exit 1
          fi
          
          # Script para descompactar no servidor
          EXTRACT_SCRIPT='
          echo "ðŸ“¦ Descompactando pacote no servidor..."
          
          # Criar diretÃ³rio temporÃ¡rio
          sudo mkdir -p /tmp/app_new
          
          # Extrair arquivos
          sudo tar xzf /tmp/app.tar.gz -C /tmp/app_new --strip-components=1
          
          # Verificar se extraiu corretamente
          if [ -z "$(ls -A /tmp/app_new)" ]; then
            echo "âŒ ERRO: Nenhum arquivo extraÃ­do!"
            exit 1
          fi
          
          echo "âœ… Arquivos extraÃ­dos: $(ls -la /tmp/app_new | wc -l) itens"
          
          # Criar backup do antigo
          if [ -d "${{ env.APP_DIR }}" ]; then
            sudo mkdir -p ${{ env.APP_DIR }}.backup
            sudo cp -r ${{ env.APP_DIR }}/* ${{ env.APP_DIR }}.backup/ 2>/dev/null || true
            echo "âœ… Backup criado em ${{ env.APP_DIR }}.backup"
          fi
          
          # Limpar diretÃ³rio atual
          sudo mkdir -p ${{ env.APP_DIR }}
          sudo rm -rf ${{ env.APP_DIR }}/*
          
          # Mover novos arquivos
          sudo mv /tmp/app_new/* ${{ env.APP_DIR }}/
          
          # Limpar temporÃ¡rios
          sudo rm -rf /tmp/app_new
          sudo rm -f /tmp/app.tar.gz
          
          echo "âœ… Arquivos movidos para ${{ env.APP_DIR }}"
          '
          
          # Executar script no servidor
          if [ -f "$SSH_CONFIG_PATH" ]; then
            ssh -F "$SSH_CONFIG_PATH" ${{ env.FRONTEND_HOST }} "$EXTRACT_SCRIPT"
          else
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "$EXTRACT_SCRIPT"
          fi
          
          if [ $? -eq 0 ]; then
            echo "âœ… Arquivos copiados e preparados no servidor"
          else
            echo "âŒ Falha ao preparar arquivos no servidor"
            exit 1
          fi

      - name: Configure Nginx and Permissions
        run: |
          echo "ðŸ”§ Configurando Nginx e permissÃµes..."
          
          SSH_CONFIG_PATH="$HOME/.ssh/config"
          
          SERVER_SCRIPT='
          echo "ðŸ”§ Configurando permissÃµes..."
          
          # Ajustar permissÃµes
          sudo chown -R nginx:nginx ${{ env.APP_DIR }}
          sudo chmod -R 755 ${{ env.APP_DIR }}
          
          echo "âœ… PermissÃµes configuradas"
          
          echo "ðŸ”§ Configurando Nginx..."
          
          # Criar configuraÃ§Ã£o Nginx
          sudo tee /etc/nginx/conf.d/heroesplatform.conf > /dev/null << "NGINXCONFIG_EOF"
          server {
              listen 80;
              listen [::]:80;
              server_name ${{ vars.FRONTEND_HOST }} www.${{ vars.FRONTEND_HOST }};
              
              # IMPORTANTE: Angular 17+ compila para browser/ dentro de dist
              root ${{ env.APP_DIR }}/browser;
              index index.html;
              
              # Logs
              access_log /var/log/nginx/heroesplatform-access.log;
              error_log /var/log/nginx/heroesplatform-error.log;
              
              # Gzip
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
              
              # Security headers
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
              
              # Angular SPA routing
              location / {
                  try_files $uri $uri/ /index.html;
                  
                  # Cache estÃ¡ticos
                  location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }
              
              # Bloquear arquivos ocultos
              location ~ /\. {
                  deny all;
                  access_log off;
                  log_not_found off;
              }
              
              # Proxy para API se necessÃ¡rio
              location /api/ {
                  proxy_pass http://localhost:3020;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          NGINXCONFIG_EOF
          
          echo "âœ… ConfiguraÃ§Ã£o do Nginx criada"
          
          # Testar configuraÃ§Ã£o
          echo "ðŸ§ª Testando configuraÃ§Ã£o do Nginx..."
          if sudo nginx -t; then
            echo "âœ… ConfiguraÃ§Ã£o do Nginx vÃ¡lida"
            
            # Recarregar Nginx
            sudo systemctl reload nginx
            echo "âœ… Nginx recarregado"
            
            # Verificar se estÃ¡ rodando
            if sudo systemctl is-active --quiet nginx; then
              echo "âœ… Nginx estÃ¡ rodando"
            else
              echo "âš ï¸  Nginx nÃ£o estÃ¡ rodando, iniciando..."
              sudo systemctl start nginx
            fi
          else
            echo "âŒ ERRO: ConfiguraÃ§Ã£o do Nginx invÃ¡lida!"
            sudo nginx -t
            exit 1
          fi
          
          echo "ðŸŽ‰ Deploy concluÃ­do com sucesso!"
          '
          
          # Executar script
          if [ -f "$SSH_CONFIG_PATH" ]; then
            ssh -F "$SSH_CONFIG_PATH" ${{ env.FRONTEND_HOST }} "$SERVER_SCRIPT"
          else
            ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ env.SSH_PORT }} ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "$SERVER_SCRIPT"
          fi

      - name: Health Check
        run: |
          echo "ðŸ¥ Verificando saÃºde da aplicaÃ§Ã£o..."
          sleep 8  # Dar tempo para o Nginx recarregar
          
          # Tentar acessar a aplicaÃ§Ã£o
          MAX_RETRIES=5
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Tentativa $i de $MAX_RETRIES..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ env.FRONTEND_HOST }} || echo "000")
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ] || [ "$HTTP_CODE" = "304" ]; then
              echo "âœ… AplicaÃ§Ã£o estÃ¡ respondendo! HTTP $HTTP_CODE"
              exit 0
            else
              echo "âš ï¸  HTTP $HTTP_CODE - Aguardando..."
              sleep 3
            fi
          done
          
          echo "âš ï¸  AplicaÃ§Ã£o nÃ£o respondeu apÃ³s $MAX_RETRIES tentativas"
          echo "Verifique manualmente: http://${{ env.FRONTEND_HOST }}"
          exit 0  # NÃ£o falha o workflow, apenas avisa

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f ~/.ssh/config
          echo "âœ… Limpeza concluÃ­da"