name: Deploy Frontend to AWS

on:
  push:
    branches:
      - main
      - master

env:
  AWS_REGION: us-east-1
  FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}
  SSH_HOST: ${{ vars.SSH_HOST || vars.FRONTEND_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /var/www/app
  SSH_PORT: ${{ vars.SSH_PORT || '22' }}
  SSH_TIMEOUT: 30

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate required secrets and variables
        run: |
          if [ -z "${{ vars.FRONTEND_HOST }}" ]; then
            echo "Error: FRONTEND_HOST variable is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "All required secrets and variables are set"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build application
        run: npm run build

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          cat > ~/.ssh/config << EOF
          Host ${{ env.FRONTEND_HOST }}
            HostName ${{ env.SSH_HOST }}
            Port ${{ env.SSH_PORT }}
            User ${{ env.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF

            - name: Copy files to EC2
        run: |
          # Caminhos absolutos
          SSH_KEY="$HOME/.ssh/deploy_key"
          BUILD_SRC="./dist/avaliador_de_herois/browser"
          
          # Verificar se build existe
          if [ ! -f "$BUILD_SRC/index.html" ]; then
            echo "‚ùå ERROR: index.html n√£o encontrado em $BUILD_SRC/"
            echo "Conte√∫do de dist/:"
            ls -la ./dist/
            exit 1
          fi
          
          echo "‚úÖ Build verificado: $BUILD_SRC"
          
          # Copiar usando scp/rsync simples
          echo "Copiando arquivos para o servidor..."
          scp -i "$SSH_KEY" \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -P ${{ env.SSH_PORT }} \
            -r "$BUILD_SRC"/* \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/tmp/app-build/
          
          echo "‚úÖ Arquivos copiados com sucesso"

      - name: Deploy to server
        run: |
          # Script de deploy no servidor
          ssh -F ~/.ssh/config ${{ env.FRONTEND_HOST }} '
          # 1. Verificar se arquivos foram copiados
          if [ ! -d "/tmp/app-build" ] || [ -z "$(ls -A /tmp/app-build)" ]; then
            echo "‚ùå ERROR: /tmp/app-build n√£o existe ou est√° vazio!"
            exit 1
          fi
          
          echo "‚úÖ Arquivos recebidos. Estrutura:"
          ls -la /tmp/app-build/ | head -10
          
          # 2. Criar diret√≥rio da aplica√ß√£o
          sudo mkdir -p /var/www/app/browser
          
          # 3. Limpar e copiar arquivos
          sudo rm -rf /var/www/app/browser/*
          sudo cp -r /tmp/app-build/* /var/www/app/browser/
          
          # 4. Verificar se index.html existe
          if [ ! -f "/var/www/app/browser/index.html" ]; then
            echo "‚ùå ERROR: index.html n√£o encontrado em /var/www/app/browser/"
            echo "Conte√∫do do diret√≥rio:"
            ls -la /var/www/app/browser/
            exit 1
          fi
          
          # 5. Configurar permiss√µes
          sudo chown -R nginx:nginx /var/www/app
          sudo chmod -R 755 /var/www/app
          
          echo "‚úÖ Arquivos copiados e permiss√µes configuradas"
          
          # 6. Criar configura√ß√£o Nginx CORRETA
          sudo tee /etc/nginx/conf.d/heroesplatform.conf > /dev/null << EOF
          server {
              listen 80;
              listen [::]:80;
              server_name heroesplatform.com.br www.heroesplatform.com.br;
              
              root /var/www/app/browser;
              index index.html;
              
              access_log /var/log/nginx/heroesplatform-access.log;
              error_log /var/log/nginx/heroesplatform-error.log;
              
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
              
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
              
              location / {
                  try_files \$uri \$uri/ /index.html;
                  
                  location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }
              
              location ~ /\. {
                  deny all;
                  access_log off;
                  log_not_found off;
              }
              
              location /api/ {
                  proxy_pass http://100.52.213.205:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade \$http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
          }
          EOF
          
          # 7. Testar e recarregar Nginx
          if sudo nginx -t; then
            echo "‚úÖ Configura√ß√£o Nginx v√°lida"
            sudo systemctl reload nginx
            echo "‚úÖ Nginx recarregado"
          else
            echo "‚ùå ERROR: Configura√ß√£o Nginx inv√°lida"
            sudo nginx -t
            exit 1
          fi
          
          # 8. Testar localmente
          echo "Testando aplica√ß√£o localmente..."
          curl -s -H "Host: heroesplatform.com.br" http://localhost | grep -o "<title>[^<]*</title>" || echo "‚úÖ Aplica√ß√£o respondendo"
          
          # 9. Limpar
          sudo rm -rf /tmp/app-build
          
          echo "üöÄ DEPLOY CONCLU√çDO COM SUCESSO!"
          '

      - name: Verify deployment
        run: |
          sleep 3
          echo "Verificando deploy..."
          curl -f -I http://${{ env.FRONTEND_HOST }} || echo "‚ö†Ô∏è  Ainda n√£o acess√≠vel externamente"
          echo "‚úÖ Processo de deploy completo"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key