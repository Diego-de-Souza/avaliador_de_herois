name: Deploy Frontend to AWS with SSL

on:
  push:
    branches:
      - main
      - master

env:
  AWS_REGION: us-east-1
  FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}
  SSH_HOST: ${{ vars.SSH_HOST || vars.FRONTEND_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /var/www/app
  SSH_PORT: ${{ vars.SSH_PORT || '22' }}
  SSH_TIMEOUT: 30
  SSL_EMAIL: plataformaheroes20250820@gmail.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate required secrets and variables
        run: |
          if [ -z "${{ vars.FRONTEND_HOST }}" ]; then
            echo "Error: FRONTEND_HOST variable is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          echo "All required secrets and variables are set"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Angular Environment Files
        env:
          # Garantir que API_URL sempre tenha https://
          API_URL: ${{ vars.API_URL || 'https://api.heroesplatform.com.br/api' }}
          ID_CLIENTE_GOOGLE: ${{ vars.ID_CLIENTE_GOOGLE || '' }}
          SECRET_KEY_GOOGLE: ${{ secrets.SECRET_KEY_GOOGLE || '' }}
          STRIPE_PUBLIC_KEY: ${{ vars.STRIPE_PUBLIC_KEY || '' }}
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY || '' }}
        run: |
          echo "ğŸ”§ Configurando environment do Angular..."
          echo "API_URL: $API_URL"
          
          # Garantir que API_URL tem https://
          if [[ ! "$API_URL" =~ ^https?:// ]]; then
            echo "âš ï¸  API_URL nÃ£o tem protocolo. Adicionando https://..."
            API_URL="https://$API_URL"
            echo "Novo API_URL: $API_URL"
          fi
          
          mkdir -p src/environments
          
          # MÃ©todo SEGURO sem heredoc problemÃ¡tico
          echo "ğŸ“¦ Gerando environment.prod.ts..."
          
          echo 'export const environment = {' > src/environments/environment.prod.ts
          echo '  production: true,' >> src/environments/environment.prod.ts
          echo "  apiURL: '$API_URL'," >> src/environments/environment.prod.ts
          echo "  ID_CLIENTE_GOOGLE: '$ID_CLIENTE_GOOGLE'," >> src/environments/environment.prod.ts
          echo "  SECRET_KEY_GOOGLE: '$SECRET_KEY_GOOGLE'," >> src/environments/environment.prod.ts
          echo "  stripePublicKey: '$STRIPE_PUBLIC_KEY'," >> src/environments/environment.prod.ts
          echo "  encryptionKey: '$ENCRYPTION_KEY'" >> src/environments/environment.prod.ts
          echo '};' >> src/environments/environment.prod.ts
          
          echo "ğŸ“¦ Gerando environment.ts..."
          
          echo 'export const environment = {' > src/environments/environment.ts
          echo '  production: false,' >> src/environments/environment.ts
          echo "  apiURL: '$API_URL'," >> src/environments/environment.ts
          echo "  ID_CLIENTE_GOOGLE: '$ID_CLIENTE_GOOGLE'," >> src/environments/environment.ts
          echo "  SECRET_KEY_GOOGLE: '$SECRET_KEY_GOOGLE'," >> src/environments/environment.ts
          echo "  stripePublicKey: '$STRIPE_PUBLIC_KEY'," >> src/environments/environment.ts
          echo "  encryptionKey: '$ENCRYPTION_KEY'" >> src/environments/environment.ts
          echo '};' >> src/environments/environment.ts
          
          echo "âœ… Arquivos de environment criados"
          
          # VerificaÃ§Ã£o
          echo "=== VERIFICAÃ‡ÃƒO ==="
          echo "environment.prod.ts:"
          cat src/environments/environment.prod.ts
          echo ""
          echo "apiURL definido como: $(grep apiURL src/environments/environment.prod.ts)"

      - name: Build application
        run: |
          echo "ğŸ—ï¸  Iniciando build Angular..."
          npm run build -- --configuration production
          
          if [ ! -d "./dist" ]; then
            echo "âŒ ERROR: Pasta dist nÃ£o foi criada!"
            exit 1
          fi
          
          echo "âœ… Build concluÃ­do"
          echo "Estrutura do dist:"
          ls -la ./dist/

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          cat > ~/.ssh/config << CONFIG
          Host ${{ env.FRONTEND_HOST }}
            HostName ${{ env.SSH_HOST }}
            Port ${{ env.SSH_PORT }}
            User ${{ env.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          CONFIG

      - name: Copy files to EC2
        run: |
          SSH_KEY="$HOME/.ssh/deploy_key"
          
          # Encontrar diretÃ³rio do build
          BUILD_SRC=""
          if [ -d "./dist/avaliador_de_herois/browser" ]; then
            BUILD_SRC="./dist/avaliador_de_herois/browser"
          else
            INDEX_PATH=$(find ./dist -name "index.html" | head -1)
            if [ -n "$INDEX_PATH" ]; then
              BUILD_SRC=$(dirname "$INDEX_PATH")
            else
              echo "âŒ ERROR: NÃ£o encontrado index.html em dist/"
              exit 1
            fi
          fi
          
          echo "âœ… Build encontrado em: $BUILD_SRC"
          
          # Verificar localhost
          if grep -r "localhost:3020" "$BUILD_SRC" 2>/dev/null; then
            echo "âš ï¸  Corrigindo localhost no build..."
            find "$BUILD_SRC" -name "*.js" -type f -exec sed -i \
              "s|http://localhost:3020|https://api.heroesplatform.com.br/api|g" {} \;
          fi
          
          # Criar e copiar
          tar czf /tmp/app-build.tar.gz -C "$BUILD_SRC" .
          
          scp -i "$SSH_KEY" \
            -o StrictHostKeyChecking=no \
            -P ${{ env.SSH_PORT }} \
            /tmp/app-build.tar.gz \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/tmp/
          
          # Extrair
          ssh -i "$SSH_KEY" \
            -o StrictHostKeyChecking=no \
            -p ${{ env.SSH_PORT }} \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
            sudo rm -rf /tmp/app-build
            sudo mkdir -p /tmp/app-build
            sudo tar xzf /tmp/app-build.tar.gz -C /tmp/app-build
            sudo rm -f /tmp/app-build.tar.gz
            echo 'âœ… Arquivos extraÃ­dos em /tmp/app-build'
          "
          
          rm -f /tmp/app-build.tar.gz

      - name: Deploy to server with SSL
        run: |
          SSH_KEY="$HOME/.ssh/deploy_key"
          
          # Script de deploy
          ssh -i "$SSH_KEY" \
            -o StrictHostKeyChecking=no \
            -p ${{ env.SSH_PORT }} \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} '
          # 1. Verificar arquivos
          if [ ! -d "/tmp/app-build" ] || [ -z "$(ls -A /tmp/app-build)" ]; then
            echo "âŒ ERROR: /tmp/app-build nÃ£o existe ou estÃ¡ vazio!"
            exit 1
          fi
          
          echo "âœ… Arquivos recebidos"
          
          # 2. Corrigir localhost
          if grep -r "localhost" /tmp/app-build/*.js 2>/dev/null; then
            echo "âš ï¸  Corrigindo localhost..."
            sudo find /tmp/app-build -name "*.js" -type f -exec sed -i \
              -e "s|http://localhost:3020|https://api.heroesplatform.com.br/api|g" \
              -e "s|localhost:3020|api.heroesplatform.com.br/api|g" \
              {} \;
          fi
          
          # 3. Mover arquivos
          sudo mkdir -p /var/www/app/browser
          sudo rm -rf /var/www/app/browser/*
          sudo cp -r /tmp/app-build/* /var/www/app/browser/
          
          # 4. PermissÃµes
          sudo chown -R nginx:nginx /var/www/app
          sudo chmod -R 755 /var/www/app
          
          echo "âœ… Arquivos copiados"
          
          # 5. Configurar Nginx
          echo "ğŸ”§ Configurando Nginx..."
          
          sudo tee /etc/nginx/conf.d/heroesplatform.conf > /dev/null << "NGINX_CONFIG"
          server {
              listen 80;
              listen [::]:80;
              server_name heroesplatform.com.br www.heroesplatform.com.br;
              
              root /var/www/app/browser;
              index index.html;
              
              access_log /var/log/nginx/heroesplatform-access.log;
              error_log /var/log/nginx/heroesplatform-error.log;
              
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
              
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
              
              location / {
                  try_files $uri $uri/ /index.html;
                  
                  location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }
              
              location ~ /\. {
                  deny all;
                  access_log off;
                  log_not_found off;
              }
              
              location /api/ {
                  proxy_pass http://100.52.213.205:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
              
              location /.well-known/acme-challenge/ {
                  root /var/www/certbot;
              }
          }
          NGINX_CONFIG
          
          # 6. Testar Nginx
          if sudo nginx -t; then
            echo "âœ… ConfiguraÃ§Ã£o Nginx vÃ¡lida"
            sudo systemctl reload nginx
          else
            echo "âŒ ERROR: ConfiguraÃ§Ã£o Nginx invÃ¡lida"
            exit 1
          fi
          
          # 7. Instalar SSL
          echo "ğŸ” Instalando SSL..."
          
          if ! command -v certbot &> /dev/null; then
            echo "ğŸ“¦ Instalando Certbot..."
            sudo dnf install -y certbot python3-certbot-nginx
          fi
          
          echo "ğŸ“ Solicitando certificado..."
          if sudo certbot --nginx \
            -d heroesplatform.com.br \
            -d www.heroesplatform.com.br \
            --non-interactive \
            --agree-tos \
            --email '${{ env.SSL_EMAIL }}' \
            --redirect 2>&1; then
            echo "âœ… SSL instalado!"
          else
            echo "âš ï¸  SSL falhou, continuando sem HTTPS"
          fi
          
          # 8. Recarregar Nginx
          sudo nginx -t && sudo systemctl reload nginx
          
          # 9. Testar
          echo "ğŸŒ Testando site..."
          echo "HTTP:"
          curl -s -H "Host: heroesplatform.com.br" -I http://localhost | head -1
          
          # 10. Limpar
          sudo rm -rf /tmp/app-build
          
          echo "ğŸš€ DEPLOY CONCLUÃDO!"
          '

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key