name: Deploy Frontend to AWS

on:
  push:
    branches:
      - main
      - master

env:
  AWS_REGION: us-east-1
  FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}
  SSH_HOST: ${{ vars.SSH_HOST || vars.FRONTEND_HOST }}
  SSH_USER: ec2-user
  APP_DIR: /var/www/app
  SSH_PORT: ${{ vars.SSH_PORT || '22' }}
  SSH_TIMEOUT: 30

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate required secrets and variables
        run: |
          if [ -z "${{ vars.FRONTEND_HOST }}" ]; then
            echo "Error: FRONTEND_HOST variable is not set"
            exit 1
          fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "Error: SSH_PRIVATE_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ vars.API_URL }}" ]; then
            echo "Warning: API_URL variable not set, using default"
          fi
          echo "All required secrets and variables are set"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate Angular Environment Files
        run: |
          echo "üîß Configurando environment do Angular..."
          
          # Criar diret√≥rio se n√£o existir
          mkdir -p src/environments
          
          # Criar environment.prod.ts COM URL CORRETA DA API
          cat > src/environments/environment.prod.ts << 'EOF'
          export const environment = {
            production: true,
            apiURL: '${{ vars.API_URL || 'https://api.heroesplatform.com.br' }}',
            ID_CLIENTE_GOOGLE: '${{ vars.ID_CLIENTE_GOOGLE || '' }}',
            SECRET_KEY_GOOGLE: '${{ secrets.SECRET_KEY_GOOGLE || '' }}',
            stripePublicKey: '${{ vars.STRIPE_PUBLIC_KEY || '' }}',
            encryptionKey: '${{ secrets.ENCRYPTION_KEY || '' }}'
          };
          EOF
          
          # Criar environment.ts COM URL CORRETA DA API  
          cat > src/environments/environment.ts << 'EOF'
          export const environment = {
            production: false,
            apiURL: '${{ vars.API_URL || 'https://api.heroesplatform.com.br' }}',
            ID_CLIENTE_GOOGLE: '${{ vars.ID_CLIENTE_GOOGLE || '' }}',
            SECRET_KEY_GOOGLE: '${{ secrets.SECRET_KEY_GOOGLE || '' }}',
            stripePublicKey: '${{ vars.STRIPE_PUBLIC_KEY || '' }}',
            encryptionKey: '${{ secrets.ENCRYPTION_KEY || '' }}'
          };
          EOF
          
          echo "‚úÖ Arquivos de environment criados"
          echo "API_URL definido como: ${{ vars.API_URL || 'https://api.heroesplatform.com.br' }}"
          
          # Verificar conte√∫do
          echo "=== environment.prod.ts ==="
          cat src/environments/environment.prod.ts
          echo ""
          echo "=== environment.ts ==="
          cat src/environments/environment.ts

      - name: Build application
        run: |
          echo "üèóÔ∏è  Iniciando build Angular..."
          npm run build
          
          # Verificar se o build foi gerado corretamente
          if [ ! -d "./dist" ]; then
            echo "‚ùå ERROR: Pasta dist n√£o foi criada!"
            exit 1
          fi
          
          echo "‚úÖ Build conclu√≠do"
          echo "Estrutura do dist:"
          find ./dist -name "index.html" 2>/dev/null

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          cat > ~/.ssh/config << EOF
          Host ${{ env.FRONTEND_HOST }}
            HostName ${{ env.SSH_HOST }}
            Port ${{ env.SSH_PORT }}
            User ${{ env.SSH_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF

      - name: Copy files to EC2
        run: |
          SSH_KEY="$HOME/.ssh/deploy_key"
          
          # Encontrar o diret√≥rio do build automaticamente
          BUILD_SRC=""
          if [ -d "./dist/app/browser" ]; then
            BUILD_SRC="./dist/app/browser"
          elif [ -d "./dist/avaliador_de_herois/browser" ]; then
            BUILD_SRC="./dist/avaliador_de_herois/browser"
          elif [ -d "./dist/browser" ]; then
            BUILD_SRC="./dist/browser"
          else
            # Procurar index.html
            INDEX_PATH=$(find ./dist -name "index.html" | head -1)
            if [ -n "$INDEX_PATH" ]; then
              BUILD_SRC=$(dirname "$INDEX_PATH")
            else
              echo "‚ùå ERROR: N√£o encontrado index.html em dist/"
              find ./dist -type f 2>/dev/null | head -10
              exit 1
            fi
          fi
          
          echo "‚úÖ Build encontrado em: $BUILD_SRC"
          echo "Arquivos:"
          ls "$BUILD_SRC" | head -5
          
          # Criar tar
          tar czf /tmp/app-build.tar.gz -C "$BUILD_SRC" .
          
          # Copiar para servidor
          scp -i "$SSH_KEY" \
            -o StrictHostKeyChecking=no \
            -P ${{ env.SSH_PORT }} \
            /tmp/app-build.tar.gz \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }}:/tmp/
          
          # Extrair no servidor
          ssh -i "$SSH_KEY" \
            -o StrictHostKeyChecking=no \
            -p ${{ env.SSH_PORT }} \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} "
            sudo rm -rf /tmp/app-build
            sudo mkdir -p /tmp/app-build
            sudo tar xzf /tmp/app-build.tar.gz -C /tmp/app-build
            sudo rm -f /tmp/app-build.tar.gz
            echo '‚úÖ Arquivos extra√≠dos em /tmp/app-build'
            ls -la /tmp/app-build/ | head -3
            echo 'Verificando apiURL no build...'
            grep -o 'apiURL[^}]*' /tmp/app-build/*.js 2>/dev/null | head -2 || echo 'apiURL n√£o encontrado nos arquivos JS'
          "
          
          rm -f /tmp/app-build.tar.gz

      - name: Deploy to server
        run: |
          SSH_KEY="$HOME/.ssh/deploy_key"
          
          # Script de deploy no servidor
          ssh -i "$SSH_KEY" \
            -o StrictHostKeyChecking=no \
            -p ${{ env.SSH_PORT }} \
            ${{ env.SSH_USER }}@${{ env.SSH_HOST }} '
          # 1. Verificar se arquivos foram copiados
          if [ ! -d "/tmp/app-build" ] || [ -z "$(ls -A /tmp/app-build)" ]; then
            echo "‚ùå ERROR: /tmp/app-build n√£o existe ou est√° vazio!"
            exit 1
          fi
          
          echo "‚úÖ Arquivos recebidos"
          
          # 2. Verificar se apiURL est√° correto
          echo "Verificando apiURL no build..."
          if grep -q "localhost" /tmp/app-build/*.js 2>/dev/null; then
            echo "‚ö†Ô∏è  AVISO: Encontrado localhost nos arquivos JS. Corrigindo..."
            sudo find /tmp/app-build -name "*.js" -type f -exec sed -i "s|http://localhost:3020|https://api.heroesplatform.com.br|g" {} \;
            sudo find /tmp/app-build -name "*.js" -type f -exec sed -i "s|localhost:3020|api.heroesplatform.com.br|g" {} \;
            echo "‚úÖ localhost corrigido para api.heroesplatform.com.br"
          fi
          
          # 3. Criar diret√≥rio da aplica√ß√£o
          sudo mkdir -p /var/www/app/browser
          
          # 4. Limpar e copiar arquivos
          sudo rm -rf /var/www/app/browser/*
          sudo cp -r /tmp/app-build/* /var/www/app/browser/
          
          # 5. Verificar se index.html existe
          if [ ! -f "/var/www/app/browser/index.html" ]; then
            echo "‚ùå ERROR: index.html n√£o encontrado em /var/www/app/browser/"
            exit 1
          fi
          
          # 6. Configurar permiss√µes
          sudo chown -R nginx:nginx /var/www/app
          sudo chmod -R 755 /var/www/app
          
          echo "‚úÖ Arquivos copiados e permiss√µes configuradas"
          
          # 7. Criar configura√ß√£o Nginx
          sudo tee /etc/nginx/conf.d/heroesplatform.conf > /dev/null << "EOF"
          server {
              listen 80;
              listen [::]:80;
              server_name heroesplatform.com.br www.heroesplatform.com.br;
              
              root /var/www/app/browser;
              index index.html;
              
              access_log /var/log/nginx/heroesplatform-access.log;
              error_log /var/log/nginx/heroesplatform-error.log;
              
              gzip on;
              gzip_vary on;
              gzip_min_length 1024;
              gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
              
              add_header X-Frame-Options "SAMEORIGIN" always;
              add_header X-Content-Type-Options "nosniff" always;
              add_header X-XSS-Protection "1; mode=block" always;
              
              location / {
                  try_files $uri $uri/ /index.html;
                  
                  location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }
              }
              
              location ~ /\. {
                  deny all;
                  access_log off;
                  log_not_found off;
              }
              
              location /api/ {
                  proxy_pass http://100.52.213.205:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
              }
          }
          EOF
          
          # 8. Testar e recarregar Nginx
          if sudo nginx -t; then
            echo "‚úÖ Configura√ß√£o Nginx v√°lida"
            sudo systemctl reload nginx
            echo "‚úÖ Nginx recarregado"
          else
            echo "‚ùå ERROR: Configura√ß√£o Nginx inv√°lida"
            sudo nginx -t
            exit 1
          fi
          
          # 9. Testar localmente
          echo "Testando aplica√ß√£o localmente..."
          curl -s -H "Host: heroesplatform.com.br" http://localhost | grep -o "<title>[^<]*</title>" || echo "‚úÖ Aplica√ß√£o respondendo"
          
          # 10. Limpar
          sudo rm -rf /tmp/app-build
          
          echo "üöÄ DEPLOY CONCLU√çDO COM SUCESSO!"
          '

      - name: Verify deployment
        run: |
          sleep 3
          echo "Verifica√ß√£o final..."
          echo "Site deve estar acess√≠vel em: http://${{ env.FRONTEND_HOST }}"
          echo "‚úÖ Processo de deploy completo"

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key